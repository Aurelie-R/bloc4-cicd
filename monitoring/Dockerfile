# monitoring/Dockerfile

# ============================================================================
# Stage 1: Builder - Installation des d√©pendances
# ============================================================================
FROM python:3.10-slim as builder

# D√©finir le r√©pertoire de travail
WORKDIR /build

# Installer les d√©pendances syst√®me n√©cessaires pour compiler certains packages Python
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    python3-dev \
    && rm -rf /var/lib/apt/lists/*

# Copier uniquement requirements.txt d'abord (pour optimiser le cache Docker)
COPY requirements.txt .

# Installer les d√©pendances Python dans un environnement virtuel
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Installer les packages Python
RUN pip install --no-cache-dir --upgrade pip setuptools wheel && \
    pip install --no-cache-dir -r requirements.txt


# ============================================================================
# Stage 2: Runtime - Image finale l√©g√®re
# ============================================================================
FROM python:3.10-slim

# M√©tadonn√©es
LABEL maintainer="monmail@example.com"
LABEL description="Service de monitoring Evidently pour d√©tection de fraude"
LABEL version="1.0"

# Cr√©er un utilisateur non-root pour la s√©curit√©
RUN groupadd -r monitoring && useradd -r -g monitoring monitoring

# D√©finir le r√©pertoire de travail
WORKDIR /app

# Installer uniquement les d√©pendances syst√®me runtime minimales
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    tzdata \
    && rm -rf /var/lib/apt/lists/*

# Copier l'environnement virtuel depuis le builder
COPY --from=builder /opt/venv /opt/venv

# Activer l'environnement virtuel
ENV PATH="/opt/venv/bin:$PATH"
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Cr√©er la structure de dossiers n√©cessaire
RUN mkdir -p /app/reports \
    /app/reference_data \
    /app/logs \
    /data \
    && chown -R monitoring:monitoring /app /data

# Copier le code de l'application
COPY --chown=monitoring:monitoring . .

# D√©finir les variables d'environnement par d√©faut
ENV MONITORING_INTERVAL=daily \
    ALERT_THRESHOLD_DRIFT=0.3 \
    ALERT_THRESHOLD_F1=0.7 \
    ALERT_THRESHOLD_RECALL=0.75 \
    TZ=Europe/Paris \
    LOG_LEVEL=INFO

# Cr√©er un script d'initialisation
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "üöÄ Initialisation du service de monitoring Evidently..."\n\
\n\
# V√©rifier que les dossiers existent\n\
if [ ! -d "/app/reports" ]; then\n\
    echo "‚ùå Erreur: /app/reports n'\''existe pas"\n\
    exit 1\n\
fi\n\
\n\
if [ ! -d "/app/reference_data" ]; then\n\
    echo "‚ùå Erreur: /app/reference_data n'\''existe pas"\n\
    exit 1\n\
fi\n\
\n\
# V√©rifier que les donn√©es de r√©f√©rence existent\n\
if [ ! -f "/app/reference_data/baseline.parquet" ]; then\n\
    echo "‚ö†Ô∏è  Attention: Donn√©es de r√©f√©rence manquantes (/app/reference_data/baseline.parquet)"\n\
    echo "   Vous devez d'\''abord entra√Æner un mod√®le et g√©n√©rer les donn√©es de r√©f√©rence"\n\
    echo "   Le service va d√©marrer mais les rapports ne pourront pas √™tre g√©n√©r√©s"\n\
fi\n\
\n\
# Afficher la configuration\n\
echo ""\n\
echo "üìä Configuration:"\n\
echo "   - Intervalle: $MONITORING_INTERVAL"\n\
echo "   - Seuil Drift: $ALERT_THRESHOLD_DRIFT"\n\
echo "   - Seuil F1: $ALERT_THRESHOLD_F1"\n\
echo "   - Seuil Recall: $ALERT_THRESHOLD_RECALL"\n\
echo "   - Timezone: $TZ"\n\
echo ""\n\
\n\
# D√©marrer l'\''application\n\
echo "‚úÖ D√©marrage du service de monitoring..."\n\
exec python generate_reports.py\n\
' > /app/entrypoint.sh && chmod +x /app/entrypoint.sh

# Healthcheck - v√©rifie que le service fonctionne correctement
HEALTHCHECK --interval=1h \
    --timeout=30s \
    --start-period=10s \
    --retries=3 \
    CMD python -c "import os, sys; \
from pathlib import Path; \
from datetime import datetime, timedelta; \
reports_dir = Path('/app/reports'); \
if not reports_dir.exists(): sys.exit(1); \
reports = list(reports_dir.glob('report_*.html')); \
if not reports: print('‚ö†Ô∏è  Aucun rapport g√©n√©r√©'); sys.exit(0); \
latest = max(reports, key=lambda p: p.stat().st_mtime); \
age_hours = (datetime.now().timestamp() - latest.stat().st_mtime) / 3600; \
print(f'‚úÖ Dernier rapport: {latest.name} ({age_hours:.1f}h)'); \
sys.exit(0 if age_hours < 25 else 1)"

# Changer vers l'utilisateur non-root
USER monitoring

# Exposer un port pour un √©ventuel serveur web de visualisation des rapports
# EXPOSE 8080

# Point d'entr√©e
ENTRYPOINT ["/app/entrypoint.sh"]

# Commande par d√©faut (peut √™tre overrid√©e)
# CMD ["python", "generate_reports.py"]