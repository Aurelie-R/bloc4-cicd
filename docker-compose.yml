version: '3.9'

services:
  ml-flow:
    build:
      context: ./mlflow
      dockerfile: Dockerfile
    container_name: fraud_mlflow
    ports:
      - "5000:5000"
    volumes:
      - mlflow_data:/mlflow
      - ./mlflow:/app
    networks:
      - fraud_network
    # env_file:
    #   - .env
    environment:
      - PORT=5000
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - BACKEND_STORE_URI=${BACKEND_STORE_URI}
      - ARTIFACT_ROOT=${ARTIFACT_ROOT}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command: mlflow server --host 0.0.0.0 --port 5000 --backend-store-uri ${BACKEND_STORE_URI} --default-artifact-root ${ARTIFACT_ROOT}
  
  # Service API de prÃ©diction
  model_api:
    build:
      context: ./model_api
      dockerfile: Dockerfile
    container_name: fraud_model_api
    ports:
      - "8000:8000"
    volumes:
      - ./data:/data
      - ./model_api:/app
      - model_artifacts:/models
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - MODEL_NAME=${MODEL_NAME:-fraud_detection}
      - MODEL_STAGE=${MODEL_STAGE:-Production}
    depends_on:
      - mlflow
    networks:
      - fraud_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Service ETL/Pipeline
  pipeline:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: fraud_pipeline
    volumes:
      - ./data:/data
      - ./app:/app
      - model_artifacts:/models
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - MLFLOW_TRACKING_URI=http://mlflow:5000
    depends_on:
      mlflow:
        condition: service_started
    networks:
      - fraud_network
    command: ["./run.sh"]

    # Service de monitoring Evidently
  monitoring:
    build:
      context: ./monitoring
      dockerfile: Dockerfile
    container_name: fraud_monitoring
    volumes:
      - ./monitoring:/app
      - ./data:/data
      - monitoring_reports:/app/reports
      - monitoring_reference:/app/reference_data
    environment:
      - MONITORING_INTERVAL=${MONITORING_INTERVAL:-daily}
      - ALERT_THRESHOLD_DRIFT=${ALERT_THRESHOLD_DRIFT:-0.3}
      - ALERT_THRESHOLD_F1=${ALERT_THRESHOLD_F1:-0.7}
      - ALERT_THRESHOLD_RECALL=${ALERT_THRESHOLD_RECALL:-0.75}
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
      - TZ=Europe/Paris
    depends_on:
      - model_api
    networks:
      - fraud_network
    restart: unless-stopped

  # Service Streamlit (Dashboard)
  streamlit:
    build:
      context: ./streamlit
      dockerfile: Dockerfile
    container_name: fraud_streamlit
    ports:
      - "8501:8501"
    volumes:
      - ./streamlit:/app
      - ./data:/data
      - monitoring_reports:/reports  # AccÃ¨s aux rapports Evidently
    environment:
      - API_URL=http://model_api:8000
      - MLFLOW_TRACKING_URI=http://mlflow:5000
    depends_on:
      - model_api
      - monitoring
    networks:
      - fraud_network

  ci_pipeline:
    build:
      context: .
      dockerfile: tests/Dockerfile
    depends_on:
      ml-flow:
        condition: service_healthy  # Attend que ml-flow soit healthy
    networks:
      - fraud-network
    # env_file:
    #   - .env
    environment:
      - MLFLOW_TRACKING_URI=http://ml-flow:4000
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - BACKEND_STORE_URI=${BACKEND_STORE_URI}
      - ARTIFACT_ROOT=${ARTIFACT_ROOT}
      - BUCKET_NAME=${BUCKET_NAME}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}
      - PGHOST=${PGHOST}
      - PGDATABASE=${PGDATABASE}
      - PGUSER=${PGUSER}
      - PGPASSWORD=${PGPASSWORD}
      - PGSSLMODE=${PGSSLMODE}
      - PGCHANNELBINDING=${PGCHANNELBINDING}
    working_dir: /home
    volumes:
      - ./:/home
    command: >
      sh -c "
        echo '=== Pytest: load_model ===' &&
        pytest tests/test_load_model.py &&
        echo '=== Pytest: extract ===' &&
        pytest tests/test_extract.py &&
        echo '=== ALL TESTS GREEN ðŸš€ â†’ Running ETL ===' &&
        python app/run_pipeline.py
      "



networks:
  fraud-network:
    driver: bridge